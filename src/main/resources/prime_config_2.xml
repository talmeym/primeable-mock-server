<?xml version="1.0" encoding="UTF-8"?>
<rg:regurgitator-configuration xmlns:rg="http://core.regurgitator.emarte.com" xmlns:rge="http://extensions.regurgitator.emarte.com" xmlns:rgw="http://web.extensions.regurgitator.emarte.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
							   xsi:schemaLocation="http://core.regurgitator.emarte.com regurgitatorCore.xsd http://extensions.regurgitator.emarte.com regurgitatorExtensions.xsd http://web.extensions.regurgitator.emarte.com regurgitatorExtensionsWeb.xsd">
	<rg:decision>
		<rg:steps>
			<rg:sequence id="create-prime-key">
				<rg:build-parameter name="key"><rge:freemarker-builder all-contexts="true">${request_metadata.request_uri}:${request_headers.prime}</rge:freemarker-builder></rg:build-parameter>
				<rg:identify-session source="key"/>
			</rg:sequence>
			<rg:sequence id="create-method-key">
				<rg:build-parameter name="key"><rge:freemarker-builder all-contexts="true">${request_metadata.request_uri}:${request_metadata.method}</rge:freemarker-builder></rg:build-parameter>
				<rg:identify-session source="key"/>
			</rg:sequence>
			<rg:sequence id="priming">
				<rg:generate-parameter name="pid" generator="UUID"/>
				<rg:create-parameter name="session:pids" type="LIST_OF_STRING" merge="CONCAT" source="pid"/>
				<rg:create-parameter name="session:responses" type="LIST_OF_STRING" merge="CONCAT" source="request-payload:text"/>
				<rg:create-response source="pid"><rge:freemarker-processor>primed. pid = ${value}</rge:freemarker-processor></rg:create-response>
			</rg:sequence>
			<rg:sequence id="pid-lookup">
				<rg:decision>
					<rg:steps>
						<rg:sequence id="respond-from-pid">
							<rg:create-parameter name="index" type="NUMBER" source="session:pids"><rg:index-of-processor source="request-headers:pid"/></rg:create-parameter>
							<rg:create-response source="session:responses"><rg:index-processor source="index"/></rg:create-response>
						</rg:sequence>
						<rgw:create-http-response id="pid-error" status-code="400" value="nothing primed for this pid / method / url"/>
					</rg:steps>
					<rg:rules default-step="pid-error">
						<rg:rule step="respond-from-pid"><rg:condition source="session:pids" exists="true"/></rg:rule>
					</rg:rules>
				</rg:decision>
			</rg:sequence>
			<rg:sequence id="key-lookup">
				<rg:decision>
					<rg:steps>
						<rg:sequence id="respond-from-key">
							<rg:create-parameter name="index" type="NUMBER" source="session:responses"><rg:size-processor as-index="true"/></rg:create-parameter>
							<rg:create-response source="session:responses"><rg:index-processor source="index"/></rg:create-response>
						</rg:sequence>
						<rgw:create-http-response id="key-error" status-code="400" value="nothing primed for this url / method"/>
					</rg:steps>
					<rg:rules default-step="key-error">
						<rg:rule step="respond-from-key"><rg:condition source="session:responses" exists="true"/></rg:rule>
					</rg:rules>
				</rg:decision>
			</rg:sequence>
			<rgw:create-http-response id="prime-error" status-code="400" value="prime error - to prime, use POST, a payload, and the prime header"/>
			<rgw:create-http-response id="header-error" status-code="400" value="header error - cannot use pid and prime headers together"/>
		</rg:steps>
		<rg:rules behaviour="ALL_MATCHES">
	        <rg:rule step="create-prime-key"><rg:condition source="request-headers:prime" exists="true"/></rg:rule>
	        <rg:rule step="create-method-key"><rg:condition source="request-headers:prime" exists="false"/></rg:rule>
			<rg:rule step="prime-error">
				<rg:condition source="request-headers:prime" exists="true"/>
				<rg:condition source="request-headers:pid" exists="false"/>
				<rg:condition source="request-metadata:method" equals="POST" expectation="false"/>
			</rg:rule>
			<rg:rule step="prime-error">
				<rg:condition source="request-headers:prime" exists="true"/>
				<rg:condition source="request-headers:pid" exists="false"/>
				<rg:condition source="request-metadata:method" equals="POST"/>
				<rg:condition source="request-payload:text" exists="false"/>
			</rg:rule>
			<rg:rule step="header-error">
				<rg:condition source="request-headers:prime" exists="true"/>
				<rg:condition source="request-headers:pid" exists="true"/>
			</rg:rule>
			<rg:rule step="priming">
				<rg:condition source="request-headers:prime" exists="true"/>
				<rg:condition source="request-headers:pid" exists="false"/>
				<rg:condition source="request-metadata:method" equals="POST"/>
				<rg:condition source="request-payload:text" exists="true"/>
			</rg:rule>
			<rg:rule step="pid-lookup">
				<rg:condition source="request-headers:prime" exists="false"/>
				<rg:condition source="request-headers:pid" exists="true"/>
			</rg:rule>
			<rg:rule step="key-lookup">
				<rg:condition source="request-headers:prime" exists="false"/>
				<rg:condition source="request-headers:pid" exists="false"/>
			</rg:rule>
		</rg:rules>
	</rg:decision>
</rg:regurgitator-configuration>